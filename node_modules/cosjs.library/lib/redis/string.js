"use strict"
//基于redis的缓存
const base = require('./base');

exports = module.exports = function(RedisKey,PrefixChar){
    return new redis_string(RedisKey,PrefixChar);
}

class redis_string extends base{

    constructor(RedisKey,PrefixChar) {
        super(RedisKey,PrefixChar);
    }

    get(key, callback) {
        var rkey  = this.hash(key);
        var redis = this.connect(true);
        if (Array.isArray(rkey)) {
            redis.MGET(rkey, callback);
        }
        else {
            redis.GET(rkey, callback);
        }
    }

    set(key, val, expire, callback) {
        if(typeof expire == 'function'){
            callback = arguments[2];
            expire = 0;
        }
        else if(!callback){
            callback = this.callback;
        }
        //获取CONN
        var redis = this.connect();
        if (typeof(key) === 'object') {
            var data = {};
            for (var k in key) {
                var rk = this.hash(k);
                data[rk] = typeof key[k] === 'object' ? JSON.stringify(key[k]) : key[k];
            }
            redis.MSET(data, callback);//expire
        }
        else {
            if (typeof(val) === 'object') {
                val = JSON.stringify(val);
            }
            var rkey = this.hash(key);
            if(expire){
                redis.SETEX ( rkey, expire, val, callback);
            }
            else{
                redis.SET( rkey, val, callback);
            }
        }
    }



    incr(key,val,callback) {
        callback = callback || this.callback;
        var rkey  = this.hash(key);
        var redis = this.connect();
        redis.INCR(rkey,val,callback);
    }

    decr(key,val,callback) {
        callback = callback || this.callback;
        var rkey  = this.hash(key);
        var redis = this.connect();
        redis.DECR(rkey,val,callback);
    }
};

