//同步/异步 批量执行任务
var task = function(tasks,worker,callback){
    if (!(this instanceof task)) {
        return new task(tasks,worker,callback);
    }

    var self=this, maxNum, curNum = 0,  errNum = 0, errList = [],asyn=false,interval;
    this.breakOnError = false;

    if(Array.isArray(tasks)){
        maxNum = tasks.length;
    }
    else if(typeof tasks =='object'){
        tasks = Object.keys(tasks);
        maxNum = tasks.length;
    }
    else{
        maxNum = parseInt(tasks);
        tasks  = null;
    }
    var result = function(err,ret){
        curNum ++;
        if(err){
            errNum ++;
            errList.push([err,ret]);
        }

        if( err && self.breakOnError){
            return callback(errNum,errList);
        }

        if(curNum >= maxNum){
            return callback(errNum,errList);
        }
        if(asyn){
            if(interval){
                setTimeout(asyn_callback,interval);
            }
            else{
                asyn_callback();
            }
        }
    }

    var asyn_callback = function(){
        var args = tasks ? tasks[curNum] : curNum;
        worker(args,result);
    }
    //异步执行
    this.asyn = function(ms){
        asyn = true;
        interval = ms||0;
        if(maxNum<1){
            return callback(errNum,errList);
        }
        else{
            asyn_callback();
        }
    }
    //同步执行
    this.sync = function(ms){
        asyn = false;
        interval = ms||0;
        if(maxNum<1){
            return callback(errNum,errList);
        }
        for(let i=0;i < maxNum;i++){
            var args = tasks ? tasks[i] : i;
            worker(args,result);
        }
    }
}

exports = module.exports = task;