"use strict";
const express    = require('express');
const session    = require('cosjs.session');
const library    = require('cosjs.library');

exports = module.exports = function httpServer(){

    var app = express();
    app.set('x-powered-by',false);

    app.static = function(route,option){
        var root = option['root']||null;
        app.use(route,express.static(root,option));
    }
    //启动SESSION
    app.session = function(route,option){
        app.use(route,session(option));
    }
    //创建一个服务器(路由)//
    app.server = function(route,option){
        route = route||'*';
        var root = option['root']||null;
        var method = option['method'] || 'all';
        option['dataType'] = defineReqDataType(method,option['dataType']);
        var handle_call_prototype = { app : app, loader : library('loader')(root), option : Object.freeze(option), };
        app[method](route, function (req, res, next) {
            handle_call.call(handle_call_prototype,req, res, next);
        });
        return handle_call_prototype.loader;
    };

    app.HandleBefore = function(route,func){
        var listener = handle_event.bind(null,'HandleBefore',func);
        app.use(route,listener);
    };
    app.HandleFinish = function(route,func){
        var listener = handle_event.bind(null,'HandleFinish',func);
        app.use(route,listener);
    };
    app.HandleDefine = handle_define;

    return app;
};


//handle加载器,/test/ , /test/index
function handle_call(req,res,next){
    var path = handle_subpath.call(this,req,res);
    var method = this.loader.parse(path);
    if( typeof method != 'function'  ){
        return next();
    }
    var usrAgent = handle_prototype(req,res,path,this.option);
    if(usrAgent.session && usrAgent.session.start){
        var session_start_callback_bind = session_start_callback.bind(usrAgent,method);
        usrAgent.session.start(session_start_callback_bind);
    }
    else{
        session_start_callback.call(usrAgent,method,null)
    }
};

function handle_event(name,func,req,res,next){
    if( typeof req[name] !== 'function'){
        req[name] = func;
    }
    next();
}

function handle_define(name,func){
    if(typeof name == 'object'){
        for(var k in name){
            HandleDefinePrototype(k,name[k]);
        }
    }
    else{
        handle_prototype.prototype[name] = func;
    }
}

function before_callback(method,err,ret){
    if(err){
        return this.callback(err,ret);
    }
    else{
        var handle_callback = this.callback.bind(this);
        method.call(this, handle_callback);
    }
}

function session_start_callback(method,err,ret){
    if(err){
        this.callback(err,ret);
    }
    else if(typeof this.req.HandleBefore === 'function'){
        var before_bind = before_callback.bind(this,method);
        this.req.HandleBefore.call(this,before_bind);
    }
    else {
        before_callback.call(this, method, null);
    }
}


function handle_subpath(req,res){
    var path,subpath = this.option.subpath || 0;
    if(typeof subpath == 'function'){
        path = subpath(req,res);
    }
    else if(Array.isArray(subpath)){
        path = req.path.substr(subpath[0],subpath[1]);
    }
    else if(subpath) {
        path = req.path.substr(subpath);
    }
    else{
        path = req.path;
    }
    return path;
}

function defineReqDataType(method,dataType){
    var ret;
    if(dataType){
        ret = Array.isArray(dataType) ? dataType : new Array(dataType);
    }
    if(method=='get'){
        ret =  ['query'];
    }
    else if(method=='post'){
        ret =  ['body'];
    }
    else{
        ret =  ['params','query','body'];
    }
    return ret;
}


function handle_prototype(req,res,path,option){
    if (!(this instanceof handle_prototype)) {
        return new handle_prototype(req,res,path,option);
    }
    this.req = req;
    this.res = res;
    this.path = path;
    this.output = option['output'] || 'json';
    //this.render = res.render;
    this.session = null;
    if ( req.session && req.session instanceof (session.session)) {
        this.session = req.session;
    }

    Object.defineProperty(this,'option',{ value: option, writable: false, enumerable: false, configurable: false, });
    
};

//获取参数
handle_prototype.prototype.get = function (key, type) {
    var val = null;
    for(var i in this.option.dataType){
        var k = this.option.dataType[i];
        var query = this.req[k]||{};
        if(key in query){
            val = query[key];
            break;
        }
    }
    if ( val!==null && type) {
        val = library('format')(val, type);
    }
    return val;
};

//最终回调函数
handle_prototype.prototype.callback = function(err,ret){
    if(typeof this.req.HandleFinish == 'function'){
        var arr = Array.from(arguments);
        arr.push(handle_finish.bind(this));
        this.req.HandleFinish.apply(this,arr)
    }
    else{
        handle_finish.call(this,{err:err,ret:ret||''});
    }
}


function handle_finish(data){
    this.output == 'jsonp' ? this.res.jsonp(data) : this.res.send(data);
    this.res.end();
}
